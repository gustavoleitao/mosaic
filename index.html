<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mosaico de Cubos</title>
    <style>
        body { margin: 0; }
        canvas { display: block; }
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div id="controls">
        <form id="cubeForm">
            <label for="rows">Linhas:</label>
            <input type="number" id="rows" name="rows" value="10" min="1"><br><br>
            
            <label for="cols">Colunas:</label>
            <input type="number" id="cols" name="cols" value="30" min="1"><br><br>
            
            <label>Selecione as Alturas:</label><br>
            <input type="checkbox" id="height1" name="heights" value="0.5" checked>
            <label for="height1">0.5</label><br>
            <input type="checkbox" id="height2" name="heights" value="1" checked>
            <label for="height2">1</label><br>
            <input type="checkbox" id="height3" name="heights" value="2">
            <label for="height3">2</label><br>
            <input type="checkbox" id="height4" name="heights" value="3">
            <label for="height4">3</label><br>
            <input type="checkbox" id="height5" name="heights" value="4">
            <label for="height5">4</label><br>
            <input type="checkbox" id="height6" name="heights" value="5">
            <label for="height6">5</label><br><br>
            
            <label>Selecione as Texturas:</label><br>
            <input type="checkbox" id="texture1" name="textures" value="https://cdn.architextures.org/textures/20/11/oak-5fc4cb29cb8cc-1200.jpg" checked>
            <label for="texture1">Madeira de Carvalho</label><br>
            <input type="checkbox" id="texture2" name="textures" value="https://cdn.architextures.org/textures/20/11/ash-5fc4cb2f0d6d2-1200.jpg">
            <label for="texture2">Madeira de Freixo</label><br>
            <input type="checkbox" id="texture3" name="textures" value="https://cdn.architextures.org/textures/20/11/charred-timber-5fc4cb0884792-1200.jpg">
            <label for="texture3">Madeira Queimada</label><br><br>
            
            <button type="submit">Gerar Mosaico</button>
        </form>

        <button id="exportMap">Exportar Mapa (JSON)</button><br><br>
        <input type="file" id="importMap" accept=".json">
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script>

        const cache = {};
        let currentMosaic = [];

        // Função para criar cubo com textura
        function cube(width=1, height=1, depth=1, texture){
            return textureCube(width, height, depth, texture);
        }

        // Função para criar cubo com material
        function materialCube(width=1, height=1, depth=1, material){
            const geometry = new THREE.BoxGeometry(width, height, depth);
            const cube = new THREE.Mesh(geometry, material);
            return cube;
        }

        // Função para pegar textura em cache ou carregar
        function getTexture(path){
            if (cache[path]) {
                return cache[path];
            } else {
                const textureLoader = new THREE.TextureLoader();
                const woodTexture = textureLoader.load(path);
                cache[path] = woodTexture;
                return woodTexture;
            }
        }

        // Função para criar cubo com textura
        function textureCube(width=1, height=1, depth=1, path){
            const material = new THREE.MeshBasicMaterial({ map: getTexture(path) });
            return materialCube(width, height, depth, material);
        }

        // Função auxiliar para selecionar valor aleatório de uma lista
        function randomFromValues(values){
            const randomIndex = Math.floor(Math.random() * values.length);
            return values[randomIndex];
        }

        // Função para criar cubo de madeira aleatória com altura aleatória
        function getRandomWoodCube(width, depth, heights, textures, row, col){
            const height = randomFromValues(heights);
            const randomTexture = randomFromValues(textures);
            const myCube = cube(width, height, depth, randomTexture);

            // Posicionar o cubo de modo que sua base fique em Y=0 (plano de base)
            myCube.position.y = height / 2;  // Ajusta para que a base do cubo fique alinhada no eixo Y

            currentMosaic.push({ row, col, height, texture: randomTexture }); // Salva o cubo no mapa

            return myCube;
        }

        // Configuração da cena e câmera
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xDDDDDD);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        // Função para criar a malha de cubos com base nas entradas do usuário
        function createMosaic(rows, cols, heights, textures) {
            currentMosaic = []; // Limpar o mapa atual

            // Remover todos os cubos antigos da cena
            while(scene.children.length > 0){ 
                scene.remove(scene.children[0]); 
            }

            const cubeWidth = 1;
            const cubeDepth = 1;
            const gap = 0.01;  // Distância entre os cubos

            // Criando a malha de cubos
            for (let i = 0; i < rows; i++) {
                for (let j = 0; j < cols; j++) {
                    const cube = getRandomWoodCube(cubeWidth, cubeDepth, heights, textures, i, j);
                    const xPosition = j * (cubeWidth + gap);
                    const zPosition = i * (cubeDepth + gap);
                    cube.position.set(xPosition, cube.position.y, zPosition);
                    scene.add(cube);
                }
            }

            // Posicionando a câmera
            camera.position.set(3, 4, 10);
            camera.lookAt(0, 0, 0);
        }

        // Função de renderização
        function render() {
            controls.update();
            renderer.render(scene, camera);
        }

        // Chamando a função de renderização continuamente
        renderer.setAnimationLoop(render);

        // Ajustar o tamanho do canvas ao redimensionar a janela
        window.addEventListener('resize', () => {
            const width = window.innerWidth;
            const height = window.innerHeight;
            renderer.setSize(width, height);
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
        });

        // Função para processar o formulário
        document.getElementById('cubeForm').addEventListener('submit', function(event) {
            event.preventDefault();  // Impedir o envio padrão do formulário

            // Capturar os valores do formulário
            const rows = parseInt(document.getElementById('rows').value);
            const cols = parseInt(document.getElementById('cols').value);

            // Capturar as alturas selecionadas (checkboxes)
            const selectedHeights = Array.from(document.querySelectorAll('input[name="heights"]:checked'))
                .map(input => parseFloat(input.value));

            if (selectedHeights.length === 0) {
                alert("Por favor, selecione ao menos uma altura.");
                return;
            }

            // Capturar as texturas selecionadas (checkboxes)
            const selectedTextures = Array.from(document.querySelectorAll('input[name="textures"]:checked'))
                .map(input => input.value);

            if (selectedTextures.length === 0) {
                alert("Por favor, selecione ao menos uma textura.");
                return;
            }

            // Criar o mosaico de cubos com os valores inseridos
            createMosaic(rows, cols, selectedHeights, selectedTextures);
        });

                // Gera a cena inicial ao carregar
                createMosaic(10, 30, [0.5, 1], [
            'https://cdn.architextures.org/textures/20/11/oak-5fc4cb29cb8cc-1200.jpg',
            'https://cdn.architextures.org/textures/20/11/ash-5fc4cb2f0d6d2-1200.jpg',
            'https://cdn.architextures.org/textures/20/11/charred-timber-5fc4cb0884792-1200.jpg'
        ]);

        // Função para exportar o mosaico como JSON
        document.getElementById('exportMap').addEventListener('click', function() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(currentMosaic, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "mosaic_map.json");
            document.body.appendChild(downloadAnchorNode); // Requerido para o Firefox
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        });

        // Função para importar um mapa de mosaico a partir de um JSON
        document.getElementById('importMap').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const jsonData = JSON.parse(e.target.result);
                    importMosaic(jsonData);
                };
                reader.readAsText(file);
            }
        });

        // Função para importar e criar a cena a partir de um mapa (JSON)
        function importMosaic(mosaicMap) {
            currentMosaic = mosaicMap; // Atualiza o mosaico atual com o importado

            // Limpar a cena
            while(scene.children.length > 0){ 
                scene.remove(scene.children[0]); 
            }

            const cubeWidth = 1;
            const cubeDepth = 1;
            const gap = 0.005;

            // Adicionar cubos a partir do mapa importado
            mosaicMap.forEach(cubeData => {
                const myCube = cube(cubeWidth, cubeData.height, cubeDepth, cubeData.texture);
                myCube.position.set(cubeData.col * (cubeWidth + gap), cubeData.height / 2, cubeData.row * (cubeDepth + gap));
                scene.add(myCube);
            });

            // Reposicionar a câmera
            camera.position.set(3, 4, 10);
            camera.lookAt(0, 0, 0);
        }

    </script>
</body>
</html>